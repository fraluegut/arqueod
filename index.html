<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>ArqueoDenuncia ¬∑ ArqueoTimes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#f5efe8; --paper:#ffffff; --ink:#2a1b12; --muted:#6b4b3a;
      --line:#e7d8cc; --soft:#f0e6dc;
      --accent:#8b5a2b; --accent2:#5b3a22;
      --shadow:0 18px 45px rgba(16,12,10,.16);
      --focus:rgba(139,90,43,.22);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--ink);
      background: radial-gradient(1200px 650px at 20% 0%, #fff 0%, var(--bg) 55%), var(--bg);
    }

    .wrap{min-height:100vh; padding:16px 12px 24px; display:flex; justify-content:center;}
    .app{width:100%; max-width:980px; margin:0 auto;}

    .top{
      border:1px solid var(--line);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.95), var(--soft));
      overflow:hidden;
    }
    .heroLogo{padding:16px 16px 10px; display:flex; justify-content:center;}
    .heroLogo img{
      width:min(900px,100%); height:auto; display:block;
      filter:drop-shadow(0 10px 18px rgba(16,12,10,.18));
    }
    .topbar{
      padding:12px 16px 14px;
      border-top:1px solid var(--line);
      background:rgba(255,255,255,.65);
    }
    .title{margin:0; font-weight:950; font-size:1.25rem; color:var(--accent2); letter-spacing:.2px;}
    .lead{margin:8px 0 0; color:var(--muted); line-height:1.55; font-size:.98rem;}

    .shell{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:22px;
      background:var(--paper);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .shellhead{
      padding:12px 16px;
      border-bottom:1px solid var(--line);
      background:#fff;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .progress{
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:.93rem;
    }
    .bar{
      width:160px; height:8px; border-radius:999px; background:var(--soft);
      overflow:hidden; border:1px solid var(--line);
    }
    .bar > div{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent2));}

    .stage{ padding:16px; background:#fff; }

    .card{
      border:1px solid var(--line);
      border-radius:20px;
      background: linear-gradient(180deg, #fff, rgba(240,230,220,.45));
      padding: 16px;
    }
    .kicker{
      color:var(--muted);
      font-size:.86rem;
      letter-spacing:.06em;
      text-transform:uppercase;
      margin:0 0 8px;
    }
    .q{
      margin:0 0 10px;
      font-weight:950;
      font-size:1.25rem;
      color:var(--accent2);
    }
    .hint{margin:0 0 12px; color:var(--muted); line-height:1.5;}

    label.h{display:block; font-weight:900; margin:10px 0 6px;}

    label.opt{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      margin-top:8px;
      cursor:pointer;
    }
    label.opt input{margin-top:2px}
    .opt .t{font-weight:850}
    .opt .d{display:block; margin-top:2px; color:var(--muted); font-size:.93rem; font-weight:500}

    /* Tarjetas seleccionables */
    .selectCard{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      border:2px solid var(--line);
      border-radius:16px;
      background:#fff;
      margin-top:8px;
      cursor:pointer;
      transition: all .2s;
      opacity: 0.5;
    }
    .selectCard:hover{
      border-color:var(--accent);
      opacity:0.75;
    }
    .selectCard.selected{
      border-color:var(--accent2);
      background:linear-gradient(135deg, rgba(139,90,43,.08), rgba(91,58,34,.05));
      box-shadow: 0 2px 8px rgba(139,90,43,.12);
      opacity:1;
    }
    .selectCard input[type="radio"]{
      margin:0;
      width:18px;
      height:18px;
      cursor:pointer;
    }
    .selectCard .cardLabel{
      flex:1;
      font-weight:700;
      color:var(--ink);
      cursor:pointer;
    }
    .selectCard.selected .cardLabel{
      color:var(--accent2);
    }
    .selectCardGroup{
      display:grid;
      grid-template-columns:1fr;
      gap:8px;
    }
    @media (min-width:640px){
      .selectCardGroup.cols2{ grid-template-columns:1fr 1fr; }
      .selectCardGroup.cols3{ grid-template-columns:repeat(3, 1fr); }
    }

    /* ‚úÖ Fuerza el texto visible siempre (y caret visible) */
    input[type="text"], input[type="email"], textarea, select{
      width:100%;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 12px;
      font-size:1rem;
      color: var(--ink) !important;
      background:#fff !important;
      outline:none;
      caret-color: var(--ink);
      -webkit-text-fill-color: var(--ink);
    }
    textarea{min-height:140px; resize:vertical;}
    input:focus, textarea:focus, select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 4px var(--focus);
    }

    .row{display:grid; grid-template-columns:1fr; gap:10px;}
    @media (min-width:820px){ .row{grid-template-columns:1fr 1fr;} }

    .nav{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      border-radius:18px;
      padding:12px 14px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--accent2);
      font-weight:900;
      cursor:pointer;
      min-width:120px;
    }
    .btn.primary{
      border-color:var(--accent2);
      background:var(--accent2);
      color:#fff;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed;}
    .right{margin-left:auto; display:flex; gap:10px; align-items:center;}
    .mini{color:var(--muted); font-size:.93rem;}

    .footer{
      padding:12px 16px;
      border-top:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      font-size:.92rem;
      text-align:center;
    }
    .fake{
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      border:1px dashed var(--line);
      background:rgba(240,230,220,.55);
      color:var(--ink);
      font-size:.95rem;
    }

    .uploadArea{
      margin-top:12px;
      padding:20px;
      border:2px dashed var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.8);
      text-align:center;
      cursor:pointer;
      transition: all .2s;
    }
    .uploadArea:hover{
      border-color:var(--accent);
      background:rgba(240,230,220,.3);
    }
    .uploadArea input[type="file"]{
      display:none;
    }
    .uploadIcon{
      font-size:2rem;
      margin-bottom:8px;
    }
    .uploadText{
      color:var(--muted);
      font-size:.95rem;
      margin:4px 0;
    }
    .fileList{
      margin-top:12px;
    }
    .fileItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      margin-top:8px;
    }
    .fileInfo{
      display:flex;
      align-items:center;
      gap:10px;
      flex:1;
      min-width:0;
    }
    .fileName{
      font-weight:700;
      color:var(--ink);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .fileSize{
      color:var(--muted);
      font-size:.88rem;
      white-space:nowrap;
    }
    .removeFile{
      border:none;
      background:none;
      color:var(--accent);
      cursor:pointer;
      padding:4px 8px;
      font-weight:900;
      font-size:.9rem;
    }
    .removeFile:hover{
      color:var(--accent2);
    }
    .totalSize{
      margin-top:8px;
      padding:8px 12px;
      border-radius:12px;
      background:rgba(240,230,220,.4);
      color:var(--muted);
      font-size:.9rem;
      text-align:right;
    }

    .errorMsg{
      margin-top:6px;
      color:#c44;
      font-size:.88rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:4px;
    }

    /* Protecci√≥n por contrase√±a */
    #passwordOverlay{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:linear-gradient(135deg, var(--bg) 0%, var(--soft) 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    #passwordOverlay.hidden{
      display:none;
    }
    .passwordBox{
      background:var(--paper);
      border:1px solid var(--line);
      border-radius:22px;
      padding:32px;
      box-shadow:var(--shadow);
      max-width:420px;
      width:90%;
    }
    .passwordBox h2{
      margin:0 0 8px;
      font-size:1.5rem;
      color:var(--accent2);
      font-weight:950;
    }
    .passwordBox p{
      margin:0 0 20px;
      color:var(--muted);
      line-height:1.5;
    }
    .passwordBox input[type="password"]{
      width:100%;
      padding:14px;
      border:2px solid var(--line);
      border-radius:16px;
      font-size:1rem;
      margin-bottom:12px;
      outline:none;
    }
    .passwordBox input[type="password"]:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 4px var(--focus);
    }
    .passwordBox button{
      width:100%;
      padding:14px;
      border:none;
      border-radius:16px;
      background:var(--accent2);
      color:#fff;
      font-weight:900;
      font-size:1rem;
      cursor:pointer;
      transition:all .2s;
    }
    .passwordBox button:hover{
      background:var(--accent);
    }
    .passwordError{
      color:#c44;
      font-size:.88rem;
      font-weight:600;
      margin-top:8px;
      display:none;
    }
    .passwordError.show{
      display:block;
    }
    #mainContent{
      display:none;
    }
    #mainContent.unlocked{
      display:block;
    }

    @keyframes slideFadeIn {
      from { opacity:0; transform: translateX(14px); }
      to   { opacity:1; transform: translateX(0); }
    }
    .screen{display:none;}
    .screen.active{display:block; animation: slideFadeIn .22s ease both;}
  </style>
</head>

<body>
  <div id="passwordOverlay">
    <div class="passwordBox">
      <h2>üîí Acceso restringido</h2>
      <p>Introduce la contrase√±a para acceder al formulario ArqueoDenuncia.</p>
      <input type="password" id="passwordInput" placeholder="Contrase√±a" />
      <button onclick="checkPassword()">Acceder</button>
      <div class="passwordError" id="passwordError">‚ùå Contrase√±a incorrecta</div>
    </div>
  </div>

  <div id="mainContent">
  <div class="wrap">
    <div class="app">
      <div class="top">
        <div class="heroLogo">
          <img src="logo.webp" alt="ArqueoTimes">
        </div>
        <div class="topbar">
          <h1 class="title">ArqueoDenuncia ¬∑ Formulario guiado</h1>
          <p class="lead">
            Flujo por pasos. Seg√∫n lo que marques, aparecer√°n secciones espec√≠ficas (acoso, patrimonio, etc.).
            Puedes mantener el anonimato.
          </p>
        </div>
      </div>

      <div class="shell">
        <div class="shellhead">
          <div style="font-weight:950;">Asistente por pasos</div>
          <div class="progress">
            <span id="pText">Paso 1</span>
            <div class="bar"><div id="pBar"></div></div>
          </div>
        </div>

        <div class="stage" id="stage"></div>

        <div class="footer">ArqueoTimes ¬∑ ArqueoDenuncia</div>
      </div>
    </div>
  </div>
  </div>

  <script>
    // Protecci√≥n por contrase√±a
    const PASSWORD = "arqueotimes2026"; // Cambia esta contrase√±a

    function checkPassword() {
      const input = document.getElementById('passwordInput');
      const error = document.getElementById('passwordError');
      const overlay = document.getElementById('passwordOverlay');
      const mainContent = document.getElementById('mainContent');
      
      if (input.value === PASSWORD) {
        overlay.classList.add('hidden');
        mainContent.classList.add('unlocked');
        sessionStorage.setItem('authenticated', 'true');
      } else {
        error.classList.add('show');
        input.value = '';
        input.focus();
        setTimeout(() => error.classList.remove('show'), 3000);
      }
    }

    // Verificar si ya est√° autenticado en esta sesi√≥n
    if (sessionStorage.getItem('authenticated') === 'true') {
      document.getElementById('passwordOverlay').classList.add('hidden');
      document.getElementById('mainContent').classList.add('unlocked');
    }

    // Permitir enter para enviar
    document.getElementById('passwordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') checkPassword();
    });

    // ========== C√≥digo del formulario ==========
    
    // ========== Estado ==========
    const state = {
      anon: "yes",
      followup: "no",
      contact: "",
      role: "",
      categories: new Set(),
      whereType: "",
      whereRef: "",
      whenType: "",
      whenRef: "",
      summary: "",
      sourcesText: "",
      hasEvidence: new Set(),
      uploadedFiles: [],
      harassmentKinds: new Set(),
      harassmentNarrative: "",
      heritageType: "",
      heritageRisk: new Set(),
      heritageNarrative: "",
      consent1:false, consent2:false, consent3:false,
      submitStatus: ""
    };

    // ========== Helpers ==========
    const el = (tag, attrs={}, children=[]) => {
      const n = document.createElement(tag);
      let valueToSet = null;
      for (const [k,v] of Object.entries(attrs)) {
        if (k === "class") n.className = v;
        else if (k === "html") n.innerHTML = v;
        else if (k === "value" && tag === "select") {
          valueToSet = v; // Guardar para establecer despu√©s
        }
        else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
        else n.setAttribute(k, v);
      }
      for (const c of children) n.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
      // Establecer value para select despu√©s de agregar las opciones
      if (valueToSet !== null && tag === "select") {
        n.value = valueToSet;
      }
      return n;
    };

    const stage = document.getElementById("stage");
    const pText = document.getElementById("pText");
    const pBar  = document.getElementById("pBar");

    function buildFlow() {
      const base = ["intro","reporter","categories","common_context","common_summary"];
      const extra = [];
      if (state.categories.has("harassment")) extra.push("harassment_block");
      if (state.categories.has("heritage")) extra.push("heritage_block");
      const tail = ["sources","consent","done"];
      return [...base, ...extra, ...tail];
    }

    let flow = buildFlow();
    let idx = 0;

    function updateProgress() {
      flow = buildFlow();
      if (idx >= flow.length) idx = flow.length - 1;
      pText.textContent = `Paso ${Math.min(idx+1, flow.length)} de ${flow.length}`;
      const pct = Math.round(((idx+1) / flow.length) * 100);
      pBar.style.width = pct + "%";
    }

    function next() {
      flow = buildFlow();
      if (idx < flow.length - 1) idx++;
      render();
      window.scrollTo({top:0, behavior:"smooth"});
    }
    function back() {
      if (idx > 0) idx--;
      render();
      window.scrollTo({top:0, behavior:"smooth"});
    }

    // ‚úÖ Nav con bot√≥n next retornado para habilitar/deshabilitar sin re-render
    function navButtons({ canNext=true, nextLabel="Siguiente", showBack=true, onMount=null } = {}) {
      const backBtn = el("button", { class:"btn", type:"button", onclick: back }, ["Atr√°s"]);
      const nextBtn = el("button", { class:"btn primary", type:"button", onclick: next }, [nextLabel]);

      if (!showBack) backBtn.disabled = true;
      nextBtn.disabled = !canNext;

      const nav = el("div", { class:"nav" }, [
        el("div", { class:"mini" }, ["Usa Siguiente para avanzar."]),
        el("div", { class:"right" }, [
          showBack ? backBtn : el("span"),
          nextBtn
        ])
      ]);

      // hook para activar/desactivar sin render
      if (typeof onMount === "function") onMount({ nextBtn, backBtn });

      return nav;
    }

    function card({ kicker, q, hint, body, nav }) {
      return el("div", { class:"card" }, [
        el("p", { class:"kicker" }, [kicker]),
        el("h2", { class:"q" }, [q]),
        hint ? el("p", { class:"hint" }, [hint]) : el("span"),
        ...body,
        nav
      ]);
    }

    function render() {
      flow = buildFlow();
      updateProgress();
      stage.innerHTML = "";

      const currentKey = flow[idx];
      const screen = el("div", { class:"screen active" }, [ screenFor(currentKey) ]);
      stage.appendChild(screen);
    }

    // ========== Env√≠o ==========
    const SUBMIT_ENDPOINT = "https://script.google.com/macros/s/AKfycbzI2nt5TJhX3QLV8xEE8WjmatYh9YNM4XKynpQSfc_NHhSlS4m33OAw4zdB-SGxL_g/exec"; // URL Google Apps Script

    const buildPayload = () => ({
      anon: state.anon,
      followup: state.followup,
      contact: state.contact,
      role: state.role,
      categories: [...state.categories],
      whereType: state.whereType,
      whereRef: state.whereRef,
      whenType: state.whenType,
      whenRef: state.whenRef,
      summary: state.summary,
      sourcesText: state.sourcesText,
      hasEvidence: [...state.hasEvidence],
      harassmentKinds: [...state.harassmentKinds],
      harassmentNarrative: state.harassmentNarrative,
      heritageType: state.heritageType,
      heritageRisk: [...state.heritageRisk],
      heritageNarrative: state.heritageNarrative,
      consent: {
        consent1: state.consent1,
        consent2: state.consent2,
        consent3: state.consent3
      },
      sendUserEmail: !!state.contact.trim(),
      sendAdminEmail: true,
      submittedAt: new Date().toISOString()
    });

    function getCaptchaToken() {
      // Devuelve aqu√≠ el token real de reCAPTCHA/Turnstile cuando lo integres.
      return "";
    }

    async function submitReport() {
      if (!SUBMIT_ENDPOINT) {
        state.submitStatus = "Falta configurar la URL de env√≠o.";
        render();
        return;
      }

      const submitBtn = document.getElementById("submitBtn");
      if (submitBtn) submitBtn.disabled = true;
      state.submitStatus = "Enviando‚Ä¶";
      render();

      try {
        const payload = buildPayload();
        const formData = new FormData();
        formData.append("payload", JSON.stringify(payload));
        formData.append("captchaToken", getCaptchaToken());

        state.uploadedFiles.forEach((f, i) => {
          if (f.file) formData.append(`file_${i}`, f.file, f.name);
        });

        const resp = await fetch(SUBMIT_ENDPOINT, {
          method: "POST",
          body: formData
        });

        if (!resp.ok) {
          throw new Error("No se pudo enviar el formulario.");
        }

        state.submitStatus = "Enviado correctamente. Gracias por comunicarlo.";
      } catch (err) {
        state.submitStatus = "Hubo un problema al enviar. Int√©ntalo m√°s tarde.";
      } finally {
        if (submitBtn) submitBtn.disabled = false;
        render();
      }
    }

    // ========== Screens ==========
    function screenFor(key) {
      if (key === "intro") {
        return card({
          kicker:"Inicio",
          q:"Antes de empezar",
          hint:"Puedes mantener el anonimato. Este canal no sustituye una denuncia judicial o administrativa.",
          body:[],
          nav: navButtons({ showBack:false })
        });
      }

      if (key === "reporter") {
        const isValidEmail = (email) => {
          if (!email.trim()) return false;
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return emailRegex.test(email);
        };

        // Mostrar campo de email solo si NO es an√≥nimo O si quiere recibir orientaci√≥n
        const showContactField = state.anon === "no" || state.followup === "yes";

        const canNext = () => {
          // Primero: debe seleccionar su relaci√≥n con el caso (obligatorio)
          if (!state.role) return false;
          
          // Si quiere seguimiento, debe proporcionar un email v√°lido
          if (state.followup === "yes") {
            return isValidEmail(state.contact);
          }
          // Si no quiere seguimiento pero escribi√≥ algo, debe ser email v√°lido
          if (state.contact.trim()) {
            return isValidEmail(state.contact);
          }
          // Si no quiere seguimiento y no escribi√≥ nada, ok
          return true;
        };

        let nextBtnRef = null;

        const anonOpt = (val, title, desc) => el("label", { class:"opt" }, [
          el("input", { type:"radio", name:"anon", value:val, ...(state.anon===val?{checked:""}:{}),
            onchange: (e)=>{ 
              state.anon = e.target.value; 
              // Si marca an√≥nimo y ten√≠a email, limpiar
              if (e.target.value === "yes" && state.followup === "no") {
                state.contact = "";
              }
              render(); 
            }
          }),
          el("span", {}, [ el("span", { class:"t" }, [title]), el("span", { class:"d" }, [desc]) ])
        ]);

        const followOpt = (val, title, desc) => el("label", { class:"opt" }, [
          el("input", { type:"radio", name:"follow", value:val, ...(state.followup===val?{checked:""}:{}),
            onchange: (e)=>{ 
              state.followup = e.target.value;
              // Si marca "no necesito respuesta" y es an√≥nimo, limpiar email
              if (e.target.value === "no" && state.anon === "yes") {
                state.contact = "";
              }
              if (nextBtnRef) nextBtnRef.disabled = !canNext();
              render(); 
            }
          }),
          el("span", {}, [ el("span", { class:"t" }, [title]), el("span", { class:"d" }, [desc]) ])
        ]);

        const bodyElements = [
          el("div", { class:"row" }, [
            el("div", {}, [
              el("label", { class:"h" }, ["Anonimato"]),
              anonOpt("yes","S√≠, an√≥nima","No aporto datos personales."),
              anonOpt("no","No, puedo dejar contacto (opcional)","Solo se usar√≠a si fuese necesario.")
            ]),
            el("div", {}, [
              el("label", { class:"h" }, ["Seguimiento"]),
              followOpt("no","No necesito respuesta","Quiero comunicarlo y ya."),
              followOpt("yes","S√≠, quiero recibir orientaci√≥n","Puedo dejar un correo (opcional).")
            ])
          ]),

          el("label", { class:"h" }, ["¬øQu√© relaci√≥n tienes con el caso?"]),
          el("div", { class:"selectCardGroup" }, [
            ...[{v:"afectado", l:"Afectado/a directo/a"}, {v:"testigo", l:"Testigo"}, {v:"tercero", l:"Me lleg√≥ por terceros / documentaci√≥n"}, {v:"no_decir", l:"Prefiero no decirlo"}].map(opt => 
              el("label", { class: "selectCard" + (state.role === opt.v ? " selected" : "") }, [
                el("input", { type:"radio", name:"role", value:opt.v, ...(state.role===opt.v?{checked:""}:{}),
                  onchange:(e)=>{ 
                    state.role = e.target.value; 
                    if (nextBtnRef) nextBtnRef.disabled = !canNext();
                    render(); 
                  }
                }),
                el("span", { class:"cardLabel" }, [opt.l])
              ])
            )
          ])
        ];

        // Solo agregar campo de contacto si corresponde
        if (showContactField) {
          bodyElements.push(
            el("label", { class:"h" }, [
              "Contacto ",
              state.followup === "yes" ? el("span", { style:"color:var(--accent);font-weight:900;" }, ["(requerido para orientaci√≥n)"]) : "(opcional)"
            ]),
            el("input", {
              type:"text",
              placeholder: state.followup === "yes" ? "correo@dominio.com (requerido)" : "correo@dominio.com",
              value: state.contact,
              oninput:(e)=>{ 
                state.contact = e.target.value;
                if (nextBtnRef) nextBtnRef.disabled = !canNext();
              }
            })
          );

          // Mensaje de error
          if (state.contact.trim() && !isValidEmail(state.contact)) {
            bodyElements.push(
              el("div", { class:"errorMsg" }, [
                "‚ö†Ô∏è",
                "El email no tiene un formato v√°lido (debe ser: usuario@dominio.com)"
              ])
            );
          }
        }

        return card({
          kicker:"Tu configuraci√≥n",
          q:"¬øC√≥mo quieres comunicarlo?",
          hint:"Definimos anonimato, si deseas seguimiento, y tu relaci√≥n con el caso.",
          body: bodyElements,
          nav: navButtons({ 
            canNext: canNext(),
            onMount: ({ nextBtn }) => { nextBtnRef = nextBtn; }
          })
        });
      }

      if (key === "categories") {
        const toggle = (k)=> { state.categories.has(k) ? state.categories.delete(k) : state.categories.add(k); render(); };
        const opt = (k, title, desc) => el("label",{class:"opt"},[
          el("input",{type:"checkbox", ...(state.categories.has(k)?{checked:""}:{}), onchange:()=>toggle(k)}),
          el("span",{},[ el("span",{class:"t"},[title]), el("span",{class:"d"},[desc]) ])
        ]);
        const canNext = state.categories.size > 0;

        return card({
          kicker:"Clasificaci√≥n",
          q:"¬øQu√© tipo de caso es?",
          hint:"Esto activar√° preguntas espec√≠ficas m√°s adelante.",
          body:[
            opt("heritage","Patrimonio / yacimiento en riesgo","Da√±os, abandono, expolio, obras‚Ä¶"),
            opt("docs","Documentaci√≥n / archivos","P√©rdida, ocultaci√≥n, accesos‚Ä¶"),
            opt("precarity","Precariedad / irregularidades","Condiciones, presiones, contratos‚Ä¶"),
            opt("harassment","Acoso / discriminaci√≥n","Laboral, acad√©mico, sexual, represalias‚Ä¶"),
            opt("other","Otro","No encaja en lo anterior.")
          ],
          nav: navButtons({ canNext })
        });
      }

      if (key === "common_context") {
        return card({
          kicker:"Contexto com√∫n",
          q:"Ubica el caso (d√≥nde y cu√°ndo)",
          hint:"√ötil para cualquier tipo de incidencia.",
          body:[
            el("label",{class:"h"},["¬øD√≥nde ocurre o ha ocurrido?"]),
            el("div", { class:"selectCardGroup cols2" }, [
              ...[{v:"yacimiento", l:"Yacimiento arqueol√≥gico"}, {v:"edificio", l:"Edificio hist√≥rico"}, {v:"museo", l:"Museo"}, {v:"archivo", l:"Archivo o biblioteca"}, {v:"universidad", l:"Universidad / centro"}, {v:"laboral", l:"Entorno laboral"}, {v:"otro", l:"Otro"}].map(opt => 
                el("label", { class: "selectCard" + (state.whereType === opt.v ? " selected" : "") }, [
                  el("input", { type:"radio", name:"whereType", value:opt.v, ...(state.whereType===opt.v?{checked:""}:{}),
                    onchange:(e)=>{ state.whereType = e.target.value; render(); }
                  }),
                  el("span", { class:"cardLabel" }, [opt.l])
                ])
              )
            ]),
            el("label",{class:"h"},["Lugar / referencia (opcional)"]),
            el("input",{type:"text", value:state.whereRef, placeholder:"Municipio, nombre del sitio o referencia aproximada‚Ä¶",
              oninput:(e)=>{ state.whereRef = e.target.value; }
            }),
            el("label",{class:"h"},["¬øCu√°ndo ocurre o ocurri√≥?"]),
            el("div", { class:"selectCardGroup cols2" }, [
              ...[{v:"now", l:"Est√° ocurriendo ahora"}, {v:"recent", l:"Ocurri√≥ recientemente"}, {v:"past", l:"Ocurri√≥ en el pasado"}, {v:"unknown", l:"No lo s√© con certeza"}].map(opt => 
                el("label", { class: "selectCard" + (state.whenType === opt.v ? " selected" : "") }, [
                  el("input", { type:"radio", name:"whenType", value:opt.v, ...(state.whenType===opt.v?{checked:""}:{}),
                    onchange:(e)=>{ state.whenType = e.target.value; render(); }
                  }),
                  el("span", { class:"cardLabel" }, [opt.l])
                ])
              )
            ]),
            el("label",{class:"h"},["Fecha o periodo aproximado (opcional)"]),
            el("input",{type:"text", value:state.whenRef, placeholder:"Enero 2026, verano 2025, hace 2 semanas‚Ä¶",
              oninput:(e)=>{ state.whenRef = e.target.value; }
            })
          ],
          nav: navButtons({ canNext:true })
        });
      }

      if (key === "common_summary") {
        let nextBtnRef = null;

        const txt = el("textarea",{
          value: state.summary,
          placeholder:"Qu√©, c√≥mo y por qu√© es relevante‚Ä¶",
          oninput:(e)=>{
            state.summary = e.target.value;
            if (nextBtnRef) nextBtnRef.disabled = !state.summary.trim();
          }
        });

        return card({
          kicker:"Resumen",
          q:"En 3‚Äì6 l√≠neas: ¬øqu√© ha pasado?",
          hint:"Una s√≠ntesis clara ayuda much√≠simo.",
          body:[ txt ],
          nav: navButtons({
            canNext: !!state.summary.trim(),
            onMount: ({ nextBtn }) => { nextBtnRef = nextBtn; }
          })
        });
      }

      if (key === "harassment_block") {
        const toggle = (k)=> { state.harassmentKinds.has(k) ? state.harassmentKinds.delete(k) : state.harassmentKinds.add(k); render(); };
        const opt = (k,t,d)=> el("label",{class:"opt"},[
          el("input",{type:"checkbox", ...(state.harassmentKinds.has(k)?{checked:""}:{}), onchange:()=>toggle(k)}),
          el("span",{},[ el("span",{class:"t"},[t]), el("span",{class:"d"},[d]) ])
        ]);

        let nextBtnRef = null;
        const canNextNow = () => (state.harassmentKinds.size>0);

        const narrative = el("textarea",{
          value: state.harassmentNarrative,
          placeholder:"Hechos, patrones, tiempos, consecuencias‚Ä¶",
          oninput:(e)=>{
            state.harassmentNarrative = e.target.value;
            if (nextBtnRef) nextBtnRef.disabled = !canNextNow();
          }
        });

        return card({
          kicker:"Bloque espec√≠fico",
          q:"Acoso / discriminaci√≥n",
          hint:"Si es an√≥nimo, evita nombres y datos identificables.",
          body:[
            el("label",{class:"h"},["¬øQu√© tipo(s)?"]),
            opt("mobbing","Acoso laboral (mobbing)","Hostigamiento, presiones‚Ä¶"),
            opt("academic","Acoso acad√©mico","Abuso de jerarqu√≠a‚Ä¶"),
            opt("gender","Acoso sexual / por raz√≥n de g√©nero","Conductas no deseadas‚Ä¶"),
            opt("discrimination","Discriminaci√≥n","Origen, idioma, ideolog√≠a‚Ä¶"),
            opt("reprisals","Represalias","Amenazas, vetos‚Ä¶"),
            opt("other","Otro",""),
            el("label",{class:"h"},["Describe lo ocurrido (detalle)"]),
            narrative
          ],
          nav: navButtons({
            canNext: canNextNow(),
            onMount: ({ nextBtn }) => { nextBtnRef = nextBtn; }
          })
        });
      }

      if (key === "heritage_block") {
        const toggle = (k)=> { state.heritageRisk.has(k) ? state.heritageRisk.delete(k) : state.heritageRisk.add(k); render(); };
        const opt = (k,t,d)=> el("label",{class:"opt"},[
          el("input",{type:"checkbox", ...(state.heritageRisk.has(k)?{checked:""}:{}), onchange:()=>toggle(k)}),
          el("span",{},[ el("span",{class:"t"},[t]), el("span",{class:"d"},[d]) ])
        ]);

        let nextBtnRef = null;
        const canNextNow = () => (!!state.heritageType && state.heritageRisk.size>0);

        const narrative = el("textarea",{
          value: state.heritageNarrative,
          placeholder:"Qu√© ocurre, desde cu√°ndo, evidencias, urgencia‚Ä¶",
          oninput:(e)=>{
            state.heritageNarrative = e.target.value;
            if (nextBtnRef) nextBtnRef.disabled = !canNextNow();
          }
        });

        return card({
          kicker:"Bloque espec√≠fico",
          q:"Patrimonio / yacimiento en peligro",
          hint:"Si es sensible, usa referencias aproximadas.",
          body:[
            el("label",{class:"h"},["Tipo de lugar afectado"]),
            el("div", { class:"selectCardGroup cols2" }, [
              ...[{v:"yacimiento", l:"Yacimiento arqueol√≥gico"}, {v:"edificio", l:"Edificio hist√≥rico"}, {v:"museo", l:"Museo"}, {v:"archivo", l:"Archivo / biblioteca"}, {v:"otro", l:"Otro"}].map(opt => 
                el("label", { class: "selectCard" + (state.heritageType === opt.v ? " selected" : "") }, [
                  el("input", { type:"radio", name:"heritageType", value:opt.v, ...(state.heritageType===opt.v?{checked:""}:{}),
                    onchange:(e)=>{ 
                      state.heritageType = e.target.value; 
                      if (nextBtnRef) nextBtnRef.disabled = !canNextNow();
                      render(); 
                    }
                  }),
                  el("span", { class:"cardLabel" }, [opt.l])
                ])
              )
            ]),
            el("label",{class:"h"},["¬øQu√© riesgo(s) hay?"]),
            opt("expolio","Expolio / saqueo","Remociones, detectoristas‚Ä¶"),
            opt("destruccion","Destrucci√≥n o alteraci√≥n","Obras, maquinaria‚Ä¶"),
            opt("abandono","Abandono / falta de conservaci√≥n","Degradaci√≥n, vandalismo‚Ä¶"),
            opt("malas_practicas","Malas pr√°cticas t√©cnicas","Intervenciones inadecuadas‚Ä¶"),
            opt("otro","Otro",""),
            el("label",{class:"h"},["Describe la situaci√≥n (detalle)"]),
            narrative
          ],
          nav: navButtons({
            canNext: canNextNow(),
            onMount: ({ nextBtn }) => { nextBtnRef = nextBtn; }
          })
        });
      }

      if (key === "sources") {
        const toggle = (k)=> {
          if (k==="none") { state.hasEvidence = new Set(["none"]); render(); return; }
          if (state.hasEvidence.has("none")) state.hasEvidence.delete("none");
          state.hasEvidence.has(k) ? state.hasEvidence.delete(k) : state.hasEvidence.add(k);
          render();
        };
        const opt = (k,t,d)=> el("label",{class:"opt"},[
          el("input",{type:"checkbox", ...(state.hasEvidence.has(k)?{checked:""}:{}), onchange:()=>toggle(k)}),
          el("span",{},[ el("span",{class:"t"},[t]), el("span",{class:"d"},[d]) ])
        ]);

        const handleFileUpload = (e) => {
          const files = Array.from(e.target.files);
          const maxSize = 100 * 1024 * 1024; // 100 MB
          const currentSize = state.uploadedFiles.reduce((sum, f) => sum + f.size, 0);
          const newSize = files.reduce((sum, f) => sum + f.size, 0);
          
          if (currentSize + newSize > maxSize) {
            alert('El tama√±o total no puede superar los 100 MB');
            return;
          }
          
          state.uploadedFiles = [...state.uploadedFiles, ...files.map(f => ({
            name: f.name,
            size: f.size,
            type: f.type,
            file: f
          }))];
          render();
        };

        const removeFile = (index) => {
          state.uploadedFiles = state.uploadedFiles.filter((_, i) => i !== index);
          render();
        };

        const formatSize = (bytes) => {
          if (bytes < 1024) return bytes + ' B';
          if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
          return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        };

        const fileInput = el("input", { type: "file", multiple: true, accept: "image/*,video/*,.pdf,.doc,.docx,.txt", onchange: handleFileUpload });
        const uploadArea = el("div", { class: "uploadArea", onclick: () => fileInput.click() }, [
          el("div", { class: "uploadIcon" }, ["üìé"]),
          el("div", { class: "uploadText", style: "font-weight:700;color:var(--accent2);" }, ["Haz clic para adjuntar archivos"]),
          el("div", { class: "uploadText" }, ["Fotos, v√≠deos, documentos (m√°x. 100 MB total)"]),
          fileInput
        ]);

        const fileListItems = state.uploadedFiles.map((file, i) => 
          el("div", { class: "fileItem" }, [
            el("div", { class: "fileInfo" }, [
              el("span", {}, [file.type.startsWith('image/') ? 'üñºÔ∏è' : file.type.startsWith('video/') ? 'üé•' : 'üìÑ']),
              el("span", { class: "fileName" }, [file.name]),
              el("span", { class: "fileSize" }, [formatSize(file.size)])
            ]),
            el("button", { class: "removeFile", type: "button", onclick: () => removeFile(i) }, ["‚úï"])
          ])
        );

        const totalSize = state.uploadedFiles.reduce((sum, f) => sum + f.size, 0);
        const totalSizeEl = state.uploadedFiles.length > 0 ? 
          el("div", { class: "totalSize" }, [
            `Total: ${formatSize(totalSize)} / 100 MB`
          ]) : null;

        const uploadSection = el("div", {}, [
          el("label", { class: "h" }, ["Adjuntar archivos (opcional)"]),
          uploadArea,
          state.uploadedFiles.length > 0 ? el("div", { class: "fileList" }, fileListItems) : null,
          totalSizeEl
        ].filter(Boolean));

        return card({
          kicker:"Fuentes y evidencias",
          q:"¬øQu√© apoyos o fuentes existen?",
          hint:"",
          body:[
            opt("photo","Fotos","Im√°genes del lugar / situaci√≥n"),
            opt("video","V√≠deo","Grabaciones relevantes"),
            opt("docs","Documentos","Correos, informes, actas‚Ä¶"),
            opt("witnesses","Testigos","Personas que pueden confirmar"),
            opt("none","No tengo pruebas directas","Solo observaci√≥n/experiencia"),
            el("label",{class:"h"},["Describe las fuentes (opcional)"]),
            el("textarea",{ value:state.sourcesText, placeholder:"Enlaces, tipo de documento, testigos (rol)‚Ä¶",
              oninput:(e)=>{ state.sourcesText = e.target.value; }
            }),
            uploadSection,
          ],
          nav: navButtons({ canNext:true })
        });
      }

      if (key === "consent") {
        const canNext = state.consent1 && state.consent2 && state.consent3;
        const chk = (field, text)=> el("label",{class:"opt"},[
          el("input",{type:"checkbox", ...(state[field]?{checked:""}:{}),
            onchange:(e)=>{ state[field] = e.target.checked; render(); }
          }),
          el("span",{class:"t"},[text])
        ]);
        return card({
          kicker:"√öltimo paso",
          q:"Consentimiento m√≠nimo",
          hint:"Necesario para el uso responsable del canal.",
          body:[
            chk("consent1","Declaro que la informaci√≥n es veraz seg√∫n mi conocimiento."),
            chk("consent2","Entiendo que este formulario no sustituye un proceso judicial o administrativo."),
            chk("consent3","Acepto el tratamiento conforme al RGPD y a la pol√≠tica de privacidad de la Asociaci√≥n.")
          ],
          nav: navButtons({ canNext, nextLabel:"Finalizar" })
        });
      }

      if (key === "done") {
        const selected = [...state.categories].join(", ") || "‚Äî";
        return card({
          kicker:"Listo",
          q:"Formulario completado",
          hint:"Revisa el resumen y env√≠a cuando est√©s listo.",
          body:[
            el("div",{class:"fake"},[
              el("b",{},["Resumen interno (visual): "]),
              el("div",{class:"small", html:
                `<ul style="margin:8px 0 0;padding-left:18px;">
                  <li><b>An√≥nimo:</b> ${state.anon==="yes"?"s√≠":"no"}</li>
                  <li><b>Seguimiento:</b> ${state.followup==="yes"?"s√≠":"no"}</li>
                  <li><b>Relaci√≥n:</b> ${state.role||"‚Äî"}</li>
                  <li><b>Categor√≠as:</b> ${selected}</li>
                </ul>`
              })
            ]),
            state.submitStatus
              ? el("div",{class:"fake"},[state.submitStatus])
              : el("span"),
            el("button",{type:"button",class:"btn primary",onclick:submitReport, id:"submitBtn"},["Enviar"])
          ],
          nav: el("div",{class:"nav"},[
            el("div",{class:"mini"},["Puedes volver y ajustar respuestas."]),
            el("div",{class:"right"},[
              el("button",{type:"button",class:"btn",onclick: back},["Atr√°s"])
            ])
          ])
        });
      }

      return card({ kicker:"Error", q:"Pantalla no definida", hint:key, body:[], nav: navButtons() });
    }

    render();
  </script>
</body>
</html>
