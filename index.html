<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>ArqueoDenuncia ¬∑ ArqueoTimes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#f5efe8; --paper:#ffffff; --ink:#2a1b12; --muted:#6b4b3a;
      --line:#e7d8cc; --soft:#f0e6dc;
      --accent:#8b5a2b; --accent2:#5b3a22;
      --shadow:0 18px 45px rgba(16,12,10,.16);
      --focus:rgba(139,90,43,.22);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--ink);
      background: radial-gradient(1200px 650px at 20% 0%, #fff 0%, var(--bg) 55%), var(--bg);
    }

    .wrap{min-height:100vh; padding:16px 12px 24px; display:flex; justify-content:center;}
    .app{width:100%; max-width:980px; margin:0 auto;}

    .top{
      border:1px solid var(--line);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.95), var(--soft));
      overflow:hidden;
    }
    .heroLogo{padding:16px 16px 10px; display:flex; justify-content:center;}
    .heroLogo img{
      width:min(900px,100%); height:auto; display:block;
      filter:drop-shadow(0 10px 18px rgba(16,12,10,.18));
    }
    .topbar{
      padding:12px 16px 14px;
      border-top:1px solid var(--line);
      background:rgba(255,255,255,.65);
    }
    .title{margin:0; font-weight:950; font-size:1.25rem; color:var(--accent2); letter-spacing:.2px;}
    .lead{margin:8px 0 0; color:var(--muted); line-height:1.55; font-size:.98rem;}

    .shell{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:22px;
      background:var(--paper);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .shellhead{
      padding:12px 16px;
      border-bottom:1px solid var(--line);
      background:#fff;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .progress{
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:.93rem;
    }
    .bar{
      width:160px; height:8px; border-radius:999px; background:var(--soft);
      overflow:hidden; border:1px solid var(--line);
    }
    .bar > div{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent2));}

    .stage{ padding:16px; background:#fff; }

    .card{
      border:1px solid var(--line);
      border-radius:20px;
      background: linear-gradient(180deg, #fff, rgba(240,230,220,.45));
      padding: 16px;
    }
    .kicker{
      color:var(--muted);
      font-size:.86rem;
      letter-spacing:.06em;
      text-transform:uppercase;
      margin:0 0 8px;
    }
    .q{
      margin:0 0 10px;
      font-weight:950;
      font-size:1.25rem;
      color:var(--accent2);
    }
    .hint{margin:0 0 12px; color:var(--muted); line-height:1.5;}

    label.h{display:block; font-weight:900; margin:10px 0 6px;}

    label.opt{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      margin-top:8px;
      cursor:pointer;
    }
    label.opt input{margin-top:2px}
    .opt .t{font-weight:850}
    .opt .d{display:block; margin-top:2px; color:var(--muted); font-size:.93rem; font-weight:500}

    /* Tarjetas seleccionables */
    .selectCard{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      border:2px solid var(--line);
      border-radius:16px;
      background:#fff;
      margin-top:8px;
      cursor:pointer;
      transition: all .2s;
      opacity: 0.5;
    }
    .selectCard:hover{
      border-color:var(--accent);
      opacity:0.75;
    }
    .selectCard.selected{
      border-color:var(--accent2);
      background:linear-gradient(135deg, rgba(139,90,43,.08), rgba(91,58,34,.05));
      box-shadow: 0 2px 8px rgba(139,90,43,.12);
      opacity:1;
    }
    .selectCard input[type="radio"]{
      margin:0;
      width:18px;
      height:18px;
      cursor:pointer;
    }
    .selectCard .cardLabel{
      flex:1;
      font-weight:700;
      color:var(--ink);
      cursor:pointer;
    }
    .selectCard.selected .cardLabel{
      color:var(--accent2);
    }
    .selectCardGroup{
      display:grid;
      grid-template-columns:1fr;
      gap:8px;
    }
    @media (min-width:640px){
      .selectCardGroup.cols2{ grid-template-columns:1fr 1fr; }
      .selectCardGroup.cols3{ grid-template-columns:repeat(3, 1fr); }
    }

    /* ‚úÖ Fuerza el texto visible siempre (y caret visible) */
    input[type="text"], input[type="email"], textarea, select{
      width:100%;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 12px;
      font-size:1rem;
      color: var(--ink) !important;
      background:#fff !important;
      outline:none;
      caret-color: var(--ink);
      -webkit-text-fill-color: var(--ink);
    }
    textarea{min-height:140px; resize:vertical;}
    input:focus, textarea:focus, select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 4px var(--focus);
    }

    .row{display:grid; grid-template-columns:1fr; gap:10px;}
    @media (min-width:820px){ .row{grid-template-columns:1fr 1fr;} }

    .nav{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      border-radius:18px;
      padding:12px 14px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--accent2);
      font-weight:900;
      cursor:pointer;
      min-width:120px;
    }
    .btn.primary{
      border-color:var(--accent2);
      background:var(--accent2);
      color:#fff;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed;}
    .right{margin-left:auto; display:flex; gap:10px; align-items:center;}
    .mini{color:var(--muted); font-size:.93rem;}

    .footer{
      padding:12px 16px;
      border-top:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      font-size:.92rem;
      text-align:center;
    }
    .fake{
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      border:1px dashed var(--line);
      background:rgba(240,230,220,.55);
      color:var(--ink);
      font-size:.95rem;
    }

    .uploadArea{
      margin-top:12px;
      padding:20px;
      border:2px dashed var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.8);
      text-align:center;
      cursor:pointer;
      transition: all .2s;
    }
    .uploadArea:hover{
      border-color:var(--accent);
      background:rgba(240,230,220,.3);
    }
    .uploadArea input[type="file"]{
      display:none;
    }
    .uploadIcon{
      font-size:2rem;
      margin-bottom:8px;
    }
    .uploadText{
      color:var(--muted);
      font-size:.95rem;
      margin:4px 0;
    }
    .fileList{
      margin-top:12px;
    }
    .fileItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      margin-top:8px;
    }
    .fileInfo{
      display:flex;
      align-items:center;
      gap:10px;
      flex:1;
      min-width:0;
    }
    .fileName{
      font-weight:700;
      color:var(--ink);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .fileSize{
      color:var(--muted);
      font-size:.88rem;
      white-space:nowrap;
    }
    .removeFile{
      border:none;
      background:none;
      color:var(--accent);
      cursor:pointer;
      padding:4px 8px;
      font-weight:900;
      font-size:.9rem;
    }
    .removeFile:hover{
      color:var(--accent2);
    }
    .totalSize{
      margin-top:8px;
      padding:8px 12px;
      border-radius:12px;
      background:rgba(240,230,220,.4);
      color:var(--muted);
      font-size:.9rem;
      text-align:right;
    }

    .errorMsg{
      margin-top:6px;
      color:#c44;
      font-size:.88rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:4px;
    }


    @keyframes slideFadeIn {
      from { opacity:0; transform: translateX(14px); }
      to   { opacity:1; transform: translateX(0); }
    }
    .screen{display:none;}
    .screen.active{display:block; animation: slideFadeIn .22s ease both;}
  </style>
</head>

<body>

  <div class="wrap">
    <div class="app">
      <div class="top">
        <div class="heroLogo">
          <img src="logo.webp" alt="ArqueoTimes">
        </div>
        <div class="topbar">
          <h1 class="title">ArqueoDenuncia ¬∑ Formulario guiado</h1>
          <p class="lead">
            Flujo por pasos. Seg√∫n lo que marques, aparecer√°n secciones espec√≠ficas (acoso, patrimonio, etc.).
            Puedes mantener el anonimato.
          </p>
        </div>
      </div>

      <div class="shell">
        <div class="shellhead">
          <div style="font-weight:950;">Asistente por pasos</div>
          <div class="progress">
            <span id="pText">Paso 1</span>
            <div class="bar"><div id="pBar"></div></div>
          </div>
        </div>

        <div class="stage" id="stage"></div>

        <div class="footer">ArqueoTimes ¬∑ ArqueoDenuncia</div>
      </div>
    </div>
  </div>

  <script>
    // ========== C√≥digo del formulario ==========
    
    // ========== Estado ==========
    const estado = {
      anonimo: "si",
      seguimiento: "no",
      contacto: "",
      relacion: new Set(),
      categorias: new Set(),
      tipoDonde: "",
      refDonde: "",
      tipoCuando: "",
      refCuando: "",
      resumen: "",
      textoFuentes: "",
      tieneEvidencia: new Set(),
      archivosSubidos: [],
      tiposAcoso: new Set(),
      narrativaAcoso: "",
      tipoPatrimonio: "",
      riesgoPatrimonio: new Set(),
      narrativaPatrimonio: "",
      consentimiento1:false, consentimiento2:false, consentimiento3:false,
      estadoEnvio: ""
    };

    // ========== Helpers ==========
    const el = (tag, attrs={}, children=[]) => {
      const n = document.createElement(tag);
      let valueToSet = null;
      for (const [k,v] of Object.entries(attrs)) {
        if (k === "class") n.className = v;
        else if (k === "html") n.innerHTML = v;
        else if (k === "value" && tag === "select") {
          valueToSet = v; // Guardar para establecer despu√©s
        }
        else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
        else n.setAttribute(k, v);
      }
      for (const c of children) n.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
      // Establecer value para select despu√©s de agregar las opciones
      if (valueToSet !== null && tag === "select") {
        n.value = valueToSet;
      }
      return n;
    };

    const stage = document.getElementById("stage");
    const pText = document.getElementById("pText");
    const pBar  = document.getElementById("pBar");

    function construirFlujo() {
      const base = ["inicio","informante","categorias","contexto_comun","resumen_comun"];
      const extra = [];
      if (estado.categorias.has("acoso")) extra.push("bloque_acoso");
      if (estado.categorias.has("patrimonio")) extra.push("bloque_patrimonio");
      const cola = ["fuentes","consentimiento","finalizado"];
      return [...base, ...extra, ...cola];
    }

    let flujo = construirFlujo();
    let indice = 0;

    function actualizarProgreso() {
      flujo = construirFlujo();
      if (indice >= flujo.length) indice = flujo.length - 1;
      pText.textContent = `Paso ${Math.min(indice+1, flujo.length)} de ${flujo.length}`;
      const pct = Math.round(((indice+1) / flujo.length) * 100);
      pBar.style.width = pct + "%";
    }

    function siguiente() {
      flujo = construirFlujo();
      if (indice < flujo.length - 1) indice++;
      renderizar();
      window.scrollTo({top:0, behavior:"smooth"});
    }
    function atras() {
      if (indice > 0) indice--;
      renderizar();
      window.scrollTo({top:0, behavior:"smooth"});
    }

    // ‚úÖ Nav con bot√≥n siguiente retornado para habilitar/deshabilitar sin re-render
    function botonesNav({ puedeAvanzar=true, etiquetaSiguiente="Siguiente", mostrarAtras=true, alMontar=null } = {}) {
      const btnAtras = el("button", { class:"btn", type:"button", onclick: atras }, ["Atr√°s"]);
      const btnSiguiente = el("button", { class:"btn primary", type:"button", onclick: siguiente }, [etiquetaSiguiente]);

      if (!mostrarAtras) btnAtras.disabled = true;
      btnSiguiente.disabled = !puedeAvanzar;

      const nav = el("div", { class:"nav" }, [
        el("div", { class:"mini" }, ["Usa Siguiente para avanzar."]),
        el("div", { class:"right" }, [
          mostrarAtras ? btnAtras : el("span"),
          btnSiguiente
        ])
      ]);

      // hook para activar/desactivar sin renderizar
      if (typeof alMontar === "function") alMontar({ btnSiguiente, btnAtras });

      return nav;
    }

    function tarjeta({ encabezado, pregunta, pista, cuerpo, nav }) {
      return el("div", { class:"card" }, [
        el("p", { class:"kicker" }, [encabezado]),
        el("h2", { class:"q" }, [pregunta]),
        pista ? el("p", { class:"hint" }, [pista]) : el("span"),
        ...cuerpo,
        nav
      ]);
    }

    function renderizar() {
      flujo = construirFlujo();
      actualizarProgreso();
      stage.innerHTML = "";

      const claveActual = flujo[indice];
      const pantalla = el("div", { class:"screen active" }, [ pantallaPara(claveActual) ]);
      stage.appendChild(pantalla);
    }

    // ========== Env√≠o ==========
    const URL_ENVIO = "https://script.google.com/macros/s/AKfycbwOHyFTwaoZsQJFfRq6C_lypPzRHOslvKojsa6ITLsD6ZU6lspWWDGQe9noweA0XShI/exec"; // URL Google Apps Script

    const construirDatos = () => ({
      // Nombres que espera el script de Google Apps Script
      anon: estado.anonimo,
      followup: estado.seguimiento,
      contact: estado.contacto,
      role: [...estado.relacion],
      categories: [...estado.categorias],
      whereType: estado.tipoDonde,
      whereRef: estado.refDonde,
      whenType: estado.tipoCuando,
      whenRef: estado.refCuando,
      summary: estado.resumen,
      sourcesText: estado.textoFuentes,
      hasEvidence: [...estado.tieneEvidencia],
      harassmentKinds: [...estado.tiposAcoso],
      harassmentNarrative: estado.narrativaAcoso,
      heritageType: estado.tipoPatrimonio,
      heritageRisk: [...estado.riesgoPatrimonio],
      heritageNarrative: estado.narrativaPatrimonio
    });

    function obtenerTokenCaptcha() {
      // Devuelve aqu√≠ el token real de reCAPTCHA/Turnstile cuando lo integres.
      return "";
    }

    // Convierte un archivo a Base64
    function archivoABase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1]; // Quitar el prefijo data:...
          resolve({
            name: file.name,
            type: file.type,
            size: file.size,
            data: base64
          });
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function enviarInforme() {
      if (!URL_ENVIO) {
        estado.estadoEnvio = "Falta configurar la URL de env√≠o.";
        renderizar();
        return;
      }

      const btnEnviar = document.getElementById("btnEnviar");
      if (btnEnviar) btnEnviar.disabled = true;
      estado.estadoEnvio = "Enviando‚Ä¶";
      renderizar();

      try {
        const datos = construirDatos();
        
        // Convertir archivos a Base64 para incluirlos en el JSON (sin archivos grandes por ahora)
        const archivosBase64 = [];
        for (const archivo of estado.archivosSubidos) {
          if (archivo.file && archivo.size < 1024 * 1024) { // Solo archivos < 1MB
            const archivoConvertido = await archivoABase64(archivo.file);
            archivosBase64.push(archivoConvertido);
          }
        }
        datos.archivos = archivosBase64;

        // Crear un formulario oculto y enviarlo (m√°s confiable con Google Apps Script)
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = URL_ENVIO;
        form.target = 'envioFrame';
        form.style.display = 'none';
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'payload';
        input.value = JSON.stringify(datos);
        form.appendChild(input);
        
        // Crear iframe oculto para recibir la respuesta
        let iframe = document.getElementById('envioFrame');
        if (!iframe) {
          iframe = document.createElement('iframe');
          iframe.name = 'envioFrame';
          iframe.id = 'envioFrame';
          iframe.style.display = 'none';
          document.body.appendChild(iframe);
        }
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
        
        // Esperar un momento y asumir √©xito
        await new Promise(resolve => setTimeout(resolve, 2000));
        estado.estadoEnvio = "Enviado correctamente. Gracias por comunicarlo.";
      } catch (err) {
        console.error("Error al enviar:", err);
        estado.estadoEnvio = "Hubo un problema al enviar. Int√©ntalo m√°s tarde.";
      } finally {
        if (btnEnviar) btnEnviar.disabled = false;
        renderizar();
      }
    }

    // ========== Pantallas ==========
    function pantallaPara(clave) {
      if (clave === "inicio") {
        return tarjeta({
          encabezado:"Inicio",
          pregunta:"Antes de empezar",
          pista:"Puedes mantener el anonimato. Este canal no sustituye una denuncia judicial o administrativa.",
          cuerpo:[],
          nav: botonesNav({ mostrarAtras:false })
        });
      }

      if (clave === "informante") {
        const esEmailValido = (email) => {
          if (!email.trim()) return false;
          const regexEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return regexEmail.test(email);
        };

        // Mostrar campo de email solo si NO es an√≥nimo O si quiere recibir orientaci√≥n
        const mostrarCampoContacto = estado.anonimo === "no" || estado.seguimiento === "si";

        const puedeAvanzar = () => {
          // Primero: debe seleccionar al menos una relaci√≥n con el caso (obligatorio)
          if (estado.relacion.size === 0) return false;
          
          // Si quiere seguimiento, debe proporcionar un email v√°lido
          if (estado.seguimiento === "si") {
            return esEmailValido(estado.contacto);
          }
          // Si no quiere seguimiento pero escribi√≥ algo, debe ser email v√°lido
          if (estado.contacto.trim()) {
            return esEmailValido(estado.contacto);
          }
          // Si no quiere seguimiento y no escribi√≥ nada, ok
          return true;
        };

        let refBtnSiguiente = null;

        const opcionAnonimo = (val, titulo, desc) => el("label", { class:"opt" }, [
          el("input", { type:"radio", name:"anonimo", value:val, ...(estado.anonimo===val?{checked:""}:{}),
            onchange: (e)=>{ 
              estado.anonimo = e.target.value; 
              // Si marca an√≥nimo y ten√≠a email, limpiar
              if (e.target.value === "si" && estado.seguimiento === "no") {
                estado.contacto = "";
              }
              renderizar(); 
            }
          }),
          el("span", {}, [ el("span", { class:"t" }, [titulo]), el("span", { class:"d" }, [desc]) ])
        ]);

        const opcionSeguimiento = (val, titulo, desc) => el("label", { class:"opt" }, [
          el("input", { type:"radio", name:"seguimiento", value:val, ...(estado.seguimiento===val?{checked:""}:{}),
            onchange: (e)=>{ 
              estado.seguimiento = e.target.value;
              // Si marca "no necesito respuesta" y es an√≥nimo, limpiar email
              if (e.target.value === "no" && estado.anonimo === "si") {
                estado.contacto = "";
              }
              if (refBtnSiguiente) refBtnSiguiente.disabled = !puedeAvanzar();
              renderizar(); 
            }
          }),
          el("span", {}, [ el("span", { class:"t" }, [titulo]), el("span", { class:"d" }, [desc]) ])
        ]);

        const elementosCuerpo = [
          el("div", { class:"row" }, [
            el("div", {}, [
              el("label", { class:"h" }, ["Anonimato"]),
              opcionAnonimo("si","S√≠, an√≥nima","No aporto datos personales."),
              opcionAnonimo("no","No, puedo dejar contacto (opcional)","Solo se usar√≠a si fuese necesario.")
            ]),
            el("div", {}, [
              el("label", { class:"h" }, ["Seguimiento"]),
              opcionSeguimiento("no","No necesito respuesta","Quiero comunicarlo y ya."),
              opcionSeguimiento("si","S√≠, quiero recibir orientaci√≥n","Puedo dejar un correo (opcional).")
            ])
          ]),

          el("label", { class:"h" }, ["¬øQu√© relaci√≥n tienes con el caso? (puedes marcar varias)"]),
          el("div", { class:"selectCardGroup" }, [
            ...[{v:"afectado", l:"Afectado/a directo/a"}, {v:"testigo", l:"Testigo"}, {v:"tercero", l:"Me lleg√≥ por terceros / documentaci√≥n"}, {v:"no_decir", l:"Prefiero no decirlo"}].map(opcion => 
              el("label", { class: "selectCard" + (estado.relacion.has(opcion.v) ? " selected" : "") }, [
                el("input", { type:"checkbox", value:opcion.v, ...(estado.relacion.has(opcion.v)?{checked:""}:{}),
                  onchange:(e)=>{ 
                    if (e.target.checked) {
                      estado.relacion.add(opcion.v);
                    } else {
                      estado.relacion.delete(opcion.v);
                    }
                    if (refBtnSiguiente) refBtnSiguiente.disabled = !puedeAvanzar();
                    renderizar(); 
                  }
                }),
                el("span", { class:"cardLabel" }, [opcion.l])
              ])
            )
          ])
        ];

        // Solo agregar campo de contacto si corresponde
        if (mostrarCampoContacto) {
          elementosCuerpo.push(
            el("label", { class:"h" }, [
              "Contacto ",
              estado.seguimiento === "si" ? el("span", { style:"color:var(--accent);font-weight:900;" }, ["(requerido para orientaci√≥n)"]) : "(opcional)"
            ]),
            el("input", {
              type:"text",
              placeholder: estado.seguimiento === "si" ? "correo@dominio.com (requerido)" : "correo@dominio.com",
              value: estado.contacto,
              oninput:(e)=>{ 
                estado.contacto = e.target.value;
                if (refBtnSiguiente) refBtnSiguiente.disabled = !puedeAvanzar();
              }
            })
          );

          // Mensaje de error
          if (estado.contacto.trim() && !esEmailValido(estado.contacto)) {
            elementosCuerpo.push(
              el("div", { class:"errorMsg" }, [
                "‚ö†Ô∏è",
                "El email no tiene un formato v√°lido (debe ser: usuario@dominio.com)"
              ])
            );
          }
        }

        return tarjeta({
          encabezado:"Tu configuraci√≥n",
          pregunta:"¬øC√≥mo quieres comunicarlo?",
          pista:"Definimos anonimato, si deseas seguimiento, y tu relaci√≥n con el caso.",
          cuerpo: elementosCuerpo,
          nav: botonesNav({ 
            puedeAvanzar: puedeAvanzar(),
            alMontar: ({ btnSiguiente }) => { refBtnSiguiente = btnSiguiente; }
          })
        });
      }

      if (clave === "categorias") {
        const alternar = (k)=> { estado.categorias.has(k) ? estado.categorias.delete(k) : estado.categorias.add(k); renderizar(); };
        const opcion = (k, titulo, desc) => el("label",{class:"opt"},[
          el("input",{type:"checkbox", ...(estado.categorias.has(k)?{checked:""}:{}), onchange:()=>alternar(k)}),
          el("span",{},[ el("span",{class:"t"},[titulo]), el("span",{class:"d"},[desc]) ])
        ]);
        const puedeAvanzar = estado.categorias.size > 0;

        return tarjeta({
          encabezado:"Clasificaci√≥n",
          pregunta:"¬øQu√© tipo de caso es?",
          pista:"Esto activar√° preguntas espec√≠ficas m√°s adelante.",
          cuerpo:[
            opcion("patrimonio","Patrimonio / yacimiento en riesgo","Da√±os, abandono, expolio, obras‚Ä¶"),
            opcion("documentacion","Documentaci√≥n / archivos","P√©rdida, ocultaci√≥n, accesos‚Ä¶"),
            opcion("precariedad","Precariedad / irregularidades","Condiciones, presiones, contratos‚Ä¶"),
            opcion("acoso","Acoso / discriminaci√≥n","Laboral, acad√©mico, sexual, represalias‚Ä¶"),
            opcion("otro","Otro","No encaja en lo anterior.")
          ],
          nav: botonesNav({ puedeAvanzar })
        });
      }

      if (clave === "contexto_comun") {
        return tarjeta({
          encabezado:"Contexto com√∫n",
          pregunta:"Ubica el caso (d√≥nde y cu√°ndo)",
          pista:"√ötil para cualquier tipo de incidencia.",
          cuerpo:[
            el("label",{class:"h"},["¬øD√≥nde ocurre o ha ocurrido?"]),
            el("div", { class:"selectCardGroup cols2" }, [
              ...[{v:"yacimiento", l:"Yacimiento arqueol√≥gico"}, {v:"edificio", l:"Edificio hist√≥rico"}, {v:"museo", l:"Museo"}, {v:"archivo", l:"Archivo o biblioteca"}, {v:"universidad", l:"Universidad / centro"}, {v:"laboral", l:"Entorno laboral"}, {v:"otro", l:"Otro"}].map(opcion => 
                el("label", { class: "selectCard" + (estado.tipoDonde === opcion.v ? " selected" : "") }, [
                  el("input", { type:"radio", name:"tipoDonde", value:opcion.v, ...(estado.tipoDonde===opcion.v?{checked:""}:{}),
                    onchange:(e)=>{ estado.tipoDonde = e.target.value; renderizar(); }
                  }),
                  el("span", { class:"cardLabel" }, [opcion.l])
                ])
              )
            ]),
            el("label",{class:"h"},["Lugar / referencia (opcional)"]),
            el("input",{type:"text", value:estado.refDonde, placeholder:"Municipio, nombre del sitio o referencia aproximada‚Ä¶",
              oninput:(e)=>{ estado.refDonde = e.target.value; }
            }),
            el("label",{class:"h"},["¬øCu√°ndo ocurre o ocurri√≥?"]),
            el("div", { class:"selectCardGroup cols2" }, [
              ...[{v:"ahora", l:"Est√° ocurriendo ahora"}, {v:"reciente", l:"Ocurri√≥ recientemente"}, {v:"pasado", l:"Ocurri√≥ en el pasado"}, {v:"desconocido", l:"No lo s√© con certeza"}].map(opcion => 
                el("label", { class: "selectCard" + (estado.tipoCuando === opcion.v ? " selected" : "") }, [
                  el("input", { type:"radio", name:"tipoCuando", value:opcion.v, ...(estado.tipoCuando===opcion.v?{checked:""}:{}),
                    onchange:(e)=>{ estado.tipoCuando = e.target.value; renderizar(); }
                  }),
                  el("span", { class:"cardLabel" }, [opcion.l])
                ])
              )
            ]),
            el("label",{class:"h"},["Fecha o periodo aproximado (opcional)"]),
            el("input",{type:"text", value:estado.refCuando, placeholder:"Enero 2026, verano 2025, hace 2 semanas‚Ä¶",
              oninput:(e)=>{ estado.refCuando = e.target.value; }
            })
          ],
          nav: botonesNav({ puedeAvanzar:true })
        });
      }

      if (clave === "resumen_comun") {
        let refBtnSiguiente = null;

        const areaTexto = el("textarea",{
          value: estado.resumen,
          placeholder:"Qu√©, c√≥mo y por qu√© es relevante‚Ä¶",
          oninput:(e)=>{
            estado.resumen = e.target.value;
            if (refBtnSiguiente) refBtnSiguiente.disabled = !estado.resumen.trim();
          }
        });

        return tarjeta({
          encabezado:"Resumen",
          pregunta:"En 3‚Äì6 l√≠neas: ¬øqu√© ha pasado?",
          pista:"Una s√≠ntesis clara ayuda much√≠simo.",
          cuerpo:[ areaTexto ],
          nav: botonesNav({
            puedeAvanzar: !!estado.resumen.trim(),
            alMontar: ({ btnSiguiente }) => { refBtnSiguiente = btnSiguiente; }
          })
        });
      }

      if (clave === "bloque_acoso") {
        const alternar = (k)=> { estado.tiposAcoso.has(k) ? estado.tiposAcoso.delete(k) : estado.tiposAcoso.add(k); renderizar(); };
        const opcion = (k,t,d)=> el("label",{class:"opt"},[
          el("input",{type:"checkbox", ...(estado.tiposAcoso.has(k)?{checked:""}:{}), onchange:()=>alternar(k)}),
          el("span",{},[ el("span",{class:"t"},[t]), el("span",{class:"d"},[d]) ])
        ]);

        let refBtnSiguiente = null;
        const puedeAvanzarAhora = () => (estado.tiposAcoso.size>0);

        const narrativa = el("textarea",{
          value: estado.narrativaAcoso,
          placeholder:"Hechos, patrones, tiempos, consecuencias‚Ä¶",
          oninput:(e)=>{
            estado.narrativaAcoso = e.target.value;
            if (refBtnSiguiente) refBtnSiguiente.disabled = !puedeAvanzarAhora();
          }
        });

        return tarjeta({
          encabezado:"Bloque espec√≠fico",
          pregunta:"Acoso / discriminaci√≥n",
          cuerpo:[
            el("label",{class:"h"},["¬øQu√© tipo(s)?"]),
            opcion("mobbing","Acoso laboral (mobbing)","Hostigamiento, presiones‚Ä¶"),
            opcion("academico","Acoso acad√©mico","Abuso de jerarqu√≠a‚Ä¶"),
            opcion("genero","Acoso sexual / por raz√≥n de g√©nero","Conductas no deseadas‚Ä¶"),
            opcion("discriminacion","Discriminaci√≥n","Origen, idioma, ideolog√≠a‚Ä¶"),
            opcion("represalias","Represalias","Amenazas, vetos‚Ä¶"),
            opcion("otro","Otro",""),
            el("label",{class:"h"},["Describe lo ocurrido (detalle)"]),
            narrativa
          ],
          nav: botonesNav({
            puedeAvanzar: puedeAvanzarAhora(),
            alMontar: ({ btnSiguiente }) => { refBtnSiguiente = btnSiguiente; }
          })
        });
      }

      if (clave === "bloque_patrimonio") {
        const alternar = (k)=> { estado.riesgoPatrimonio.has(k) ? estado.riesgoPatrimonio.delete(k) : estado.riesgoPatrimonio.add(k); renderizar(); };
        const opcion = (k,t,d)=> el("label",{class:"opt"},[
          el("input",{type:"checkbox", ...(estado.riesgoPatrimonio.has(k)?{checked:""}:{}), onchange:()=>alternar(k)}),
          el("span",{},[ el("span",{class:"t"},[t]), el("span",{class:"d"},[d]) ])
        ]);

        let refBtnSiguiente = null;
        const puedeAvanzarAhora = () => (!!estado.tipoPatrimonio && estado.riesgoPatrimonio.size>0);

        const narrativa = el("textarea",{
          value: estado.narrativaPatrimonio,
          placeholder:"Qu√© ocurre, desde cu√°ndo, evidencias, urgencia‚Ä¶",
          oninput:(e)=>{
            estado.narrativaPatrimonio = e.target.value;
            if (refBtnSiguiente) refBtnSiguiente.disabled = !puedeAvanzarAhora();
          }
        });

        return tarjeta({
          encabezado:"Bloque espec√≠fico",
          pregunta:"Patrimonio / yacimiento en peligro",
          pista:"Si es sensible, usa referencias aproximadas.",
          cuerpo:[
            el("label",{class:"h"},["Tipo de lugar afectado"]),
            el("div", { class:"selectCardGroup cols2" }, [
              ...[{v:"yacimiento", l:"Yacimiento arqueol√≥gico"}, {v:"edificio", l:"Edificio hist√≥rico"}, {v:"museo", l:"Museo"}, {v:"archivo", l:"Archivo / biblioteca"}, {v:"otro", l:"Otro"}].map(opcion => 
                el("label", { class: "selectCard" + (estado.tipoPatrimonio === opcion.v ? " selected" : "") }, [
                  el("input", { type:"radio", name:"tipoPatrimonio", value:opcion.v, ...(estado.tipoPatrimonio===opcion.v?{checked:""}:{}),
                    onchange:(e)=>{ 
                      estado.tipoPatrimonio = e.target.value; 
                      if (refBtnSiguiente) refBtnSiguiente.disabled = !puedeAvanzarAhora();
                      renderizar(); 
                    }
                  }),
                  el("span", { class:"cardLabel" }, [opcion.l])
                ])
              )
            ]),
            el("label",{class:"h"},["¬øQu√© riesgo(s) hay?"]),
            opcion("expolio","Expolio / saqueo","Remociones, detectoristas‚Ä¶"),
            opcion("destruccion","Destrucci√≥n o alteraci√≥n","Obras, maquinaria‚Ä¶"),
            opcion("abandono","Abandono / falta de conservaci√≥n","Degradaci√≥n, vandalismo‚Ä¶"),
            opcion("malas_practicas","Malas pr√°cticas t√©cnicas","Intervenciones inadecuadas‚Ä¶"),
            opcion("otro","Otro",""),
            el("label",{class:"h"},["Describe la situaci√≥n (detalle)"]),
            narrativa
          ],
          nav: botonesNav({
            puedeAvanzar: puedeAvanzarAhora(),
            alMontar: ({ btnSiguiente }) => { refBtnSiguiente = btnSiguiente; }
          })
        });
      }

      if (clave === "fuentes") {
        const alternar = (k)=> {
          if (k==="ninguna") { estado.tieneEvidencia = new Set(["ninguna"]); renderizar(); return; }
          if (estado.tieneEvidencia.has("ninguna")) estado.tieneEvidencia.delete("ninguna");
          estado.tieneEvidencia.has(k) ? estado.tieneEvidencia.delete(k) : estado.tieneEvidencia.add(k);
          renderizar();
        };
        const opcion = (k,t,d)=> el("label",{class:"opt"},[
          el("input",{type:"checkbox", ...(estado.tieneEvidencia.has(k)?{checked:""}:{}), onchange:()=>alternar(k)}),
          el("span",{},[ el("span",{class:"t"},[t]), el("span",{class:"d"},[d]) ])
        ]);

        const manejarSubidaArchivos = (e) => {
          const archivos = Array.from(e.target.files);
          const tamanoMax = 100 * 1024 * 1024; // 100 MB
          const tamanoActual = estado.archivosSubidos.reduce((suma, f) => suma + f.size, 0);
          const tamanoNuevo = archivos.reduce((suma, f) => suma + f.size, 0);
          
          if (tamanoActual + tamanoNuevo > tamanoMax) {
            alert('El tama√±o total no puede superar los 100 MB');
            return;
          }
          
          estado.archivosSubidos = [...estado.archivosSubidos, ...archivos.map(f => ({
            name: f.name,
            size: f.size,
            type: f.type,
            file: f
          }))];
          renderizar();
        };

        const eliminarArchivo = (indice) => {
          estado.archivosSubidos = estado.archivosSubidos.filter((_, i) => i !== indice);
          renderizar();
        };

        const formatearTamano = (bytes) => {
          if (bytes < 1024) return bytes + ' B';
          if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
          return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        };

        const inputArchivo = el("input", { type: "file", multiple: true, accept: "image/*,video/*,.pdf,.doc,.docx,.txt", onchange: manejarSubidaArchivos });
        const areaSubida = el("div", { class: "uploadArea", onclick: () => inputArchivo.click() }, [
          el("div", { class: "uploadIcon" }, ["üìé"]),
          el("div", { class: "uploadText", style: "font-weight:700;color:var(--accent2);" }, ["Haz clic para adjuntar archivos"]),
          el("div", { class: "uploadText" }, ["Fotos, v√≠deos, documentos (m√°x. 100 MB total)"]),
          inputArchivo
        ]);

        const elementosListaArchivos = estado.archivosSubidos.map((archivo, i) => 
          el("div", { class: "fileItem" }, [
            el("div", { class: "fileInfo" }, [
              el("span", {}, [archivo.type.startsWith('image/') ? 'üñºÔ∏è' : archivo.type.startsWith('video/') ? 'üé•' : 'üìÑ']),
              el("span", { class: "fileName" }, [archivo.name]),
              el("span", { class: "fileSize" }, [formatearTamano(archivo.size)])
            ]),
            el("button", { class: "removeFile", type: "button", onclick: () => eliminarArchivo(i) }, ["‚úï"])
          ])
        );

        const tamanoTotal = estado.archivosSubidos.reduce((suma, f) => suma + f.size, 0);
        const elTamanoTotal = estado.archivosSubidos.length > 0 ? 
          el("div", { class: "totalSize" }, [
            `Total: ${formatearTamano(tamanoTotal)} / 100 MB`
          ]) : null;

        const seccionSubida = el("div", {}, [
          el("label", { class: "h" }, ["Adjuntar archivos (opcional)"]),
          areaSubida,
          estado.archivosSubidos.length > 0 ? el("div", { class: "fileList" }, elementosListaArchivos) : null,
          elTamanoTotal
        ].filter(Boolean));

        return tarjeta({
          encabezado:"Fuentes y evidencias",
          pregunta:"¬øQu√© apoyos o fuentes existen?",
          pista:"",
          cuerpo:[
            opcion("fotos","Fotos","Im√°genes del lugar / situaci√≥n"),
            opcion("video","V√≠deo","Grabaciones relevantes"),
            opcion("documentos","Documentos","Correos, informes, actas‚Ä¶"),
            opcion("testigos","Testigos","Personas que pueden confirmar"),
            opcion("ninguna","No tengo pruebas directas","Solo observaci√≥n/experiencia"),
            el("label",{class:"h"},["Describe las fuentes (opcional)"]),
            el("textarea",{ value:estado.textoFuentes, placeholder:"Enlaces, tipo de documento, testigos (rol)‚Ä¶",
              oninput:(e)=>{ estado.textoFuentes = e.target.value; }
            }),
            seccionSubida,
          ],
          nav: botonesNav({ puedeAvanzar:true })
        });
      }

      if (clave === "consentimiento") {
        const puedeAvanzar = estado.consentimiento1 && estado.consentimiento2 && estado.consentimiento3;
        const verificar = (campo, texto)=> el("label",{class:"opt"},[
          el("input",{type:"checkbox", ...(estado[campo]?{checked:""}:{}),
            onchange:(e)=>{ estado[campo] = e.target.checked; renderizar(); }
          }),
          el("span",{class:"t"},[texto])
        ]);
        return tarjeta({
          encabezado:"√öltimo paso",
          pregunta:"Consentimiento m√≠nimo",
          pista:"Necesario para el uso responsable del canal.",
          cuerpo:[
            verificar("consentimiento1","Declaro que la informaci√≥n es veraz seg√∫n mi conocimiento."),
            verificar("consentimiento2","Entiendo que este formulario no sustituye un proceso judicial o administrativo."),
            verificar("consentimiento3","Acepto el tratamiento conforme al RGPD y a la pol√≠tica de privacidad de la Asociaci√≥n.")
          ],
          nav: botonesNav({ puedeAvanzar, etiquetaSiguiente:"Finalizar" })
        });
      }

      if (clave === "finalizado") {
        const seleccionadas = [...estado.categorias].join(", ") || "‚Äî";
        return tarjeta({
          encabezado:"Listo",
          pregunta:"Formulario completado",
          pista:"Revisa el resumen y env√≠a cuando est√©s listo.",
          cuerpo:[
            el("div",{class:"fake"},[
              el("b",["Resumen interno (visual): "]),
              el("div",{class:"small", html:
                `<ul style="margin:8px 0 0;padding-left:18px;">
                  <li><b>An√≥nimo:</b> ${estado.anonimo==="si"?"s√≠":"no"}</li>
                  <li><b>Seguimiento:</b> ${estado.seguimiento==="si"?"s√≠":"no"}</li>
                  <li><b>Relaci√≥n:</b> ${[...estado.relacion].join(", ")||"‚Äî"}</li>
                  <li><b>Categor√≠as:</b> ${seleccionadas}</li>
                </ul>`
              })
            ]),
            estado.estadoEnvio
              ? el("div",{class:"fake"},[estado.estadoEnvio])
              : el("span"),
            el("button",{type:"button",class:"btn primary",onclick:enviarInforme, id:"btnEnviar"},["Enviar"])
          ],
          nav: el("div",{class:"nav"},[
            el("div",{class:"mini"},["Puedes volver y ajustar respuestas."]),
            el("div",{class:"right"},[
              el("button",{type:"button",class:"btn",onclick: atras},["Atr√°s"])
            ])
          ])
        });
      }

      return tarjeta({ encabezado:"Error", pregunta:"Pantalla no definida", pista:clave, cuerpo:[], nav: botonesNav() });
    }

    renderizar();
  </script>
</body>
</html>
